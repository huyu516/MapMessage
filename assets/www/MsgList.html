<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>注册</title>
	<link rel="stylesheet" href="lib/jquery.mobile/jquery.mobile.css" >
	<script src="lib/jquery.mobile/jquery.js"></script>
	<script src="lib/jquery.mobile/jquery.mobile.js"></script>
	<script src="lib/common.js"></script>
    <script src="lib/cordova.js"></script>
    <script src="lib/database.support.js"></script>
</head> 
<body> 
<div data-role="page" >
    <div data-role="header" role="banner" data-position="fixed" data-theme="b">
        <a href="#" onclick="BaseUtil.goBack();">返&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp回</a>
        <h1>地图信息</h1>
        <a href="#" onclick="BaseUtil.exit();">退出程序</a>
        <div data-role="navbar">
            <ul>
                <li><a href="MsgSearch.html" data-ajax="false" class="ui-btn-active">信息查询</a></li>
                <li><a href="Map.html" data-ajax="false" data-theme="c" >地图模式</a></li>
            </ul>
        </div>
    </div>
	<div role="main">
		<ul id="ulMsgList" data-role="listview" data-inset="true">
		</ul>
		<div id="divLoading" style="padding-left:20px;margin-top:5px;margin-bottom:5px;">
			<img src='lib/images/loading.gif' alt='正在加载' >正在加载...</img>
		</div>	
	</div>
    <div data-role="footer" class="footer-docs" data-theme="c" data-position="fixed">
    	<p style="padding-left:20px">Copyright © 2014 Huyu. All Rights Reserved</p>
    </div>	
</div>
</body>
<script>
<!--// 目前先不管distance

    var sender_name = window.sessionStorage.getItem(Consts.MSGLIST_SENDER_NAME);
    var content = window.sessionStorage.getItem(Consts.MSGLIST_CONTENT);
    var send_date_start = window.sessionStorage.getItem(Consts.MSGLIST_SEND_DATE_START);
    var send_date_end = window.sessionStorage.getItem(Consts.MSGLIST_SEND_DATE_END);
    // var distance = window.sessionStorage.getItem(Consts.MSGLIST_DISTANCE);

    var page_no = 1;
    var page_size = 10;

    function queryData() {

        var offset = (page_no - 1) * page_size;
        
        // build sql 
        var where_sql = " where is_top = 'true' ";
        var where_params = [];
        if(!BaseUtil.isEmpty(sender_name)) {
            where_sql += " and sender_name like ? ";
            where_params.push("%" + sender_name + "%"); 
        }
        
        if(!BaseUtil.isEmpty(content)) {
            where_sql += " and content like ? ";
            where_params.push("%" + content + "%");
        }
        
        if(!BaseUtil.isEmpty(send_date_start)) {
            where_sql += " and send_date >= ? "; 
            var from_dt = BaseUtil.getFromDate(send_date_start);
            where_params.push(from_dt.getTime());
        }
         
        if(!BaseUtil.isEmpty(send_date_end)) {
            where_sql += " and send_date <= ? ";
            var to_dt = BaseUtil.getToDate(send_date_end);
            where_params.push(to_dt.getTime());
        }
        
        where_params.push(page_size, offset);
        
        var sql = "select * from MapMsg " + where_sql + " order by send_date desc limit ? offset ? ";
        DBUtil.select(sql, where_params, function(tx, results) {
        
            var resutList = DBUtil.resultsToList(results);
            
            if(resutList.length < page_size) {
            	var tipHTML = "<img src='lib/images/right.png' style='width:25px;height:25px;'>"
            				+ "    已加载完全部数据！"
            				+ "</img>"
            	jQuery("#divLoading").html(tipHTML);
                $(window).unbind("scroll");
            }
            
            var innerHTML = "";
            for(var i = 0; i < resutList.length; i++) {
            	var obj = resutList[i]
            	
                innerHTML += "<li>";
                innerHTML += "    <a href='#' onclick='viewMsg(" + obj.msg_id + ")'>";
                innerHTML += "	      <h2>" + obj.content + "</h2>";
                innerHTML += "	      <p><strong>" +  BaseUtil.datetimeFormat(obj.send_date) + "&nbsp;&nbsp;" + obj.sender_name + "</strong></p>"
                innerHTML += "    </a>"
                innerHTML += "</li>" 
            }        
            
            jQuery("#ulMsgList").append(innerHTML).listview("refresh");

            page_no++;
        })
    }

	document.addEventListener("deviceready", onDeviceReady, false);	
	function onDeviceReady() {
		queryData();

        jQuery(window).bind("scroll", function(){
            if(BaseUtil.isPageBottom())
                queryData();
        })
        
        BaseUtil.toast("将屏幕向下滑动加载新数据");
	}
	
	function viewMsg(msg_id) {
	    window.sessionStorage.setItem(Consts.MSGINFO_TOP_ID, msg_id);
        window.location = "MsgInfo.html";
	}

-->
</script>
</html>
